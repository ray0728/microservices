<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ray.service.resource.mapper.ResourceMapper">
    <cache type="com.ray.service.resource.redis.RedisCache"/>
    <resultMap id="logMap" type="Log">
        <id column="id" property="id"/>
        <result column="uid" property="uid"/>
        <result column="title" property="title"/>
        <result column="date" property="date"/>
        <result column="gid" property="gid"/>
        <result column="type" property="type"/>
        <result column="like_num" property="like_num"/>
        <result column="unlike_num" property="unlike_num"/>
        <result column="status" property="status"/>
        <association property="detail" column="id" select="getLogDetail"/>
        <collection property="replyList" column="id" select="getLogReplies"/>
    </resultMap>
    <resultMap id="logDetailMap" type="LogDetail">
        <id column="id" property="id"/>
        <result column="lid" property="lid"/>
        <result column="res_url" property="res_url"/>
    </resultMap>
    <resultMap id="replyMap" type="Reply">
        <id column="id" property="id"/>
        <result column="lid" property="lid"/>
        <result column="uid" property="uid"/>
        <result column="desc" property="desc"/>
        <result column="date" property="date"/>
        <result column="like_num" property="like_num"/>
        <result column="unlike_num" property="unlike_num"/>
    </resultMap>

    <update id="changeLogStatus">
        UPDATE t_log SET status=#{status} WHERE id=#{id}
    </update>

    <select id="getLogStatus">
        SELECT status FROM t_log WHERE id=#{id}
    </select>

    <select id="getLogReplies" resultType="Reply">
        SELECT * FROM t_reply WHERE lid=#{id}
    </select>

    <select id="getLogDetail" resultType="LogDetail">
        SELECT * FROM t_log_detail WHERE lid=#{id}
    </select>

    <insert id="createLogDetail" useGeneratedKeys="true" keyProperty="id" parameterType="LogDetail">
        INSERT INTO t_log_detail(lid,res_url)
        VALUES (#{lid}, #{res_url});
    </insert>

    <insert id="createLog" useGeneratedKeys="true" keyProperty="id" parameterType="Log">
        INSERT INTO t_log(uid, title, date, gid, type, like_num, unlike_num)
        VALUES (#{uid}, #{title}, #{date}, #{gid}, #{type}, 0, 0);
    </insert>

    <insert id="createReply" useGeneratedKeys="true" keyProperty="id" parameterType="Reply">
        INSERT INTO t_reply(lid, uid, desc, date, like_num, unlike_num)
        VALUES (#{lid}, #{uid}, #{desc}, #{date}, 0, 0);
    </insert>

    <delete id="deleteLog">
        DELETE
        FROM t_log
        WHERE id = #{id};
    </delete>

    <delete id="deleteLogDetail">
        DELETE
        FROM t_log_detail
        WHERE id = #{id};
    </delete>

    <delete id="deleteReply">
        DELETE
        FROM t_reply
        WHERE id = #{id};
    </delete>

    <update id="changeLog">
        UPDATE t_log
        <set>
            <if test="title != null">title = #{title},</if>
            <if test="date != 0">date = #{date},</if>
            <if test="gid !=  0">gid = #{gid},</if>
            <if test="type != null">type = #{type},</if>
        </set>
        WHERE id = #{id};
    </update>

    <select id="getLogById" resultMap="logMap">
        SELECT *
        FROM t_log
        WHERE id = #{id};
    </select>

    <select id="getLogsByUid" resultMap="logMap">
        SELECT *
        FROM t_log
        WHERE uid = #{uid};
    </select>

    <select id="getPublicLogsByType" resultMap="logMap">
        SELECT *
        FROM t_log
        WHERE type = #{type};
    </select>

    <select id="getGroupLogsByType" resultMap="logMap">
        SELECT * FROM t_log
        <where>
            <if test="gid != 0">gid=#{gid}</if>
            <if test="type != 0">and type = #{type}</if>
        </where>
    </select>
</mapper>